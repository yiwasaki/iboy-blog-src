# Azure Firewall + UDR ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒˆãƒãƒ­ã‚¸ãƒ¼

## ãƒã‚¯ãƒ­ãƒ¬ãƒ™ãƒ«ãƒˆãƒãƒ­ã‚¸ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Azure Subscription                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Japan East Region      â”‚     â”‚  Southeast Asia Region   â”‚ â”‚
â”‚  â”‚    (japaneast)           â”‚     â”‚  (southeastasia)         â”‚ â”‚
â”‚  â”‚                          â”‚     â”‚                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚   je-vnet          â”‚  â”‚     â”‚  â”‚   sea-vnet         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  172.30.0.0/23     â”‚  â”‚     â”‚  â”‚  172.30.20.0/24    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                    â”‚  â”‚     â”‚  â”‚                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚     â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Firewall       â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ test-sea       â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ Subnet         â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ Subnet         â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ 172.30.1.0/24  â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ 172.30.20.0/25 â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                â”‚ â”‚  â”‚     â”‚  â”‚ â”‚                â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ Azure      â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚   Windows  â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ Firewall   â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚   Server   â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ (Basic)    â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚   2022     â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ fw-japaneastâ”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚ sea-win    â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ Priv IP:   â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚ 2022-01    â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ 172.30.1.4 â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚            â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ Pub IP:    â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â”‚            â”‚ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â”‚ <dynamic>  â”‚ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ UDR Applied:   â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                â”‚ â”‚  â”‚     â”‚  â”‚ â”‚ 0.0.0.0/0 â†’    â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚     â”‚  â”‚ â”‚ 172.30.1.4     â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                    â”‚  â”‚     â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                          â”‚     â”‚                          â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚   â”‚ Firewall Pub IP â”‚    â”‚     â”‚    â”‚ Storage Accts    â”‚  â”‚ â”‚
â”‚  â”‚   â”‚ fw-pip-japaneastâ”‚    â”‚     â”‚    â”‚ - test (diag)    â”‚  â”‚ â”‚
â”‚  â”‚   â”‚ Standard SKU    â”‚    â”‚     â”‚    â”‚ - iboysadiag100  â”‚  â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â†•  VNet Peering (je-vnet â†” sea-vnet)           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼å›³

```
VM (sea-win2022-01) å†…ã‹ã‚‰ã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   sea-vnet     â”‚
        â”‚  172.30.20.0/24â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    test-sea ã‚µãƒ–ãƒãƒƒãƒˆ              â”‚
        â”‚    172.30.20.0/25                  â”‚
        â”‚ (UDR ãƒ†ãƒ¼ãƒ–ãƒ«é©ç”¨)                 â”‚
        â”‚ udr-sea-to-firewall                â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ Route:                       â”‚   â”‚
        â”‚ â”‚ Destination: 0.0.0.0/0       â”‚   â”‚
        â”‚ â”‚ Next Hop: VirtualAppliance   â”‚   â”‚
        â”‚ â”‚ IP: 172.30.1.4               â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ VNet Peering: Seaâ†’JE       â”‚
        â”‚ (åŒæ–¹å‘)                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    je-vnet                 â”‚
        â”‚   172.30.0.0/23            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  AzureFirewallSubnet       â”‚
        â”‚   172.30.1.0/24            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Azure Firewall (Basic)    â”‚
        â”‚  fw-japaneast              â”‚
        â”‚                            â”‚
        â”‚ Rules:                     â”‚
        â”‚ - AllowAll (é–‹ç™º/ãƒ†ã‚¹ãƒˆç”¨) â”‚
        â”‚   (æœ¬ç•ªç’°å¢ƒã§ã¯è¦å¤‰æ›´)     â”‚
        â”‚                            â”‚
        â”‚ Threat Intel: Alert        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ / å¤–éƒ¨ãƒªã‚½ â”‚
```

## ãƒªã‚½ãƒ¼ã‚¹æ§‹æˆå›³

### æ±æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (Japan East)

```
je-vnet (172.30.0.0/23)
â”‚
â”œâ”€ AzureFirewallSubnet (172.30.1.0/24)
â”‚  â”œâ”€ Azure Firewall (Basic)
â”‚  â”‚  â”œâ”€ Name: fw-japaneast
â”‚  â”‚  â”œâ”€ SKU: AZFW_VNet / Basic
â”‚  â”‚  â”œâ”€ Private IP: 172.30.1.4 (å‹•çš„å‰²ã‚Šå½“ã¦)
â”‚  â”‚  â”œâ”€ Public IP: fw-pip-japaneast (Standard, Static)
â”‚  â”‚  â””â”€ Rules:
â”‚  â”‚     â””â”€ AllowAll (é–‹ç™º/ãƒ†ã‚¹ãƒˆ)
â”‚  â”‚
â”‚  â””â”€ Firewall Pub IP Address
â”‚     â”œâ”€ Name: fw-pip-japaneast
â”‚     â”œâ”€ SKU: Standard
â”‚     â””â”€ Allocation: Static
â”‚
â””â”€ [ãã®ä»–ã®ã‚µãƒ–ãƒãƒƒãƒˆ: main.bicep ã§å®šç¾©]
```

### æ±å—ã‚¢ã‚¸ã‚¢ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (Southeast Asia)

```
sea-vnet (172.30.20.0/24)
â”‚
â”œâ”€ test-sea ã‚µãƒ–ãƒãƒƒãƒˆ (172.30.20.0/25)
â”‚  â”œâ”€ Route Table Association:
â”‚  â”‚  â””â”€ udr-sea-to-firewall
â”‚  â”‚     â””â”€ RouteToFirewall
â”‚  â”‚        â”œâ”€ Destination: 0.0.0.0/0
â”‚  â”‚        â”œâ”€ Next Hop Type: VirtualAppliance
â”‚  â”‚        â””â”€ Next Hop IP: 172.30.1.4 (Azure Firewall Private IP)
â”‚  â”‚
â”‚  â””â”€ Windows Server 2022 VM
â”‚     â”œâ”€ Name: sea-win2022-01
â”‚     â”œâ”€ Size: Standard_B4ms
â”‚     â”œâ”€ NIC: sea-nic-01
â”‚     â”œâ”€ Public IP: (å‰²ã‚Šå½“ã¦)
â”‚     â””â”€ Admin: (æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)
â”‚
â””â”€ Storage Accounts:
   â”œâ”€ iboystragefwtest100 (è¨ºæ–­ãƒ­ã‚°)
   â””â”€ iboysadiag100 (ã‚¢ãƒ—ãƒªãƒ­ã‚°)
```

## VNet ãƒ”ã‚¢ãƒªãƒ³ã‚°è¨­å®š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     VNet Peering: je-vnet â†” sea-vnetâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Peering Name (JEâ†’SEA):            â”‚
â”‚   je-to-sea-peering                â”‚
â”‚                                    â”‚
â”‚ Peering Name (SEAâ†’JE):            â”‚
â”‚   sea-to-je-peering                â”‚
â”‚                                    â”‚
â”‚ Status: Connected                  â”‚
â”‚ Traffic Forwarding: Allow          â”‚
â”‚ Gateway Transit: (main.bicepå‚ç…§)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## NSG (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—) ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  test-sea Subnet NSG:                â”‚
â”‚  nsg-sea                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  Inbound Rules:                      â”‚
â”‚  1. AllowRDP (0.0.0.0/32, RDP:3389) â”‚
â”‚     [ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹ç”¨]                 â”‚
â”‚                                      â”‚
â”‚  2. AllowHttps (0.0.0.0/0, HTTPS)    â”‚
â”‚                                      â”‚
â”‚  Outbound Rules:                     â”‚
â”‚  1. AllowAll (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)            â”‚
â”‚     [UDR ã§ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«çµŒç”±]    â”‚
â”‚                                      â”‚
â”‚  â€» ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯ UDR ã«ã‚ˆã‚Š        â”‚
â”‚     Azure Firewall ã‚’é€šã‚Šã¾ã™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é †åº

```
1. VM ãŒãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡ (å®›å…ˆ: å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹)
   â†“
2. NIC ãŒ NSG ãƒ«ãƒ¼ãƒ«ç¢ºèª (Outbound: AllowAll)
   â†“
3. VNet ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³
   â”œâ”€ System Routes ç¢ºèª
   â”‚  â””â”€ 172.30.0.0/23 â†’ Direct (ja-vnet å†…)
   â”‚  â””â”€ 172.30.20.0/24 â†’ Direct (sea-vnet å†…)
   â”‚
   â””â”€ User-Defined Routes (UDR) ç¢ºèª
      â”œâ”€ Route Table: udr-sea-to-firewall
      â”‚  â””â”€ 0.0.0.0/0 â†’ VirtualAppliance (172.30.1.4)
      â”‚
      â””â”€ ä¸€è‡´ã—ãŸãƒ«ãƒ¼ãƒˆ: 0.0.0.0/0
         â””â”€ Next Hop: 172.30.1.4
   â†“
4. VNet Peering: sea-vnet â†’ je-vnet (å¿…è¦ã«å¿œã˜ã¦)
   â†“
5. Azure Firewall ã§ãƒ‘ã‚±ãƒƒãƒˆå‡¦ç†
   â”œâ”€ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«è©•ä¾¡: AllowAll
   â”œâ”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«: (æœªå®šç¾© = ã‚¹ã‚­ãƒƒãƒ—)
   â””â”€ NAT ãƒ«ãƒ¼ãƒ«: (æœªå®šç¾© = ã‚¹ã‚­ãƒƒãƒ—)
   â†“
6. Firewall ã‹ã‚‰å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã¸é€ä¿¡
   â””â”€ é€ä¿¡å…ƒ IP: Firewall Public IP (fw-pip-japaneast)
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ±å—ã‚¢ã‚¸ã‚¢ VM ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Layer 1: VM ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« (OS)     â”‚             â”‚
â”‚  â”‚ Windows Defender Firewall ãªã©       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Layer 2: NSG (Subnet Level)         â”‚             â”‚
â”‚  â”‚ nsg-sea                             â”‚             â”‚
â”‚  â”‚ [Inbound: RDP, HTTPSè¨±å¯]            â”‚             â”‚
â”‚  â”‚ [Outbound: AllowAll]                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Layer 3: UDR (ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¤)        â”‚             â”‚
â”‚  â”‚ udr-sea-to-firewall                 â”‚             â”‚
â”‚  â”‚ 0.0.0.0/0 â†’ 172.30.1.4 (Firewall)   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Layer 4: Azure Firewall             â”‚             â”‚
â”‚  â”‚ fw-japaneast (Basic SKU)            â”‚             â”‚
â”‚  â”‚ - Network Rules                     â”‚             â”‚
â”‚  â”‚ - Threat Intelligence (Alert mode)  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚              â†“                                        â”‚
â”‚   ãƒ‘ã‚±ãƒƒãƒˆå¤–éƒ¨ã«é€ä¿¡ (Firewall PIP çµŒç”±)             â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ã‚³ã‚¹ãƒˆæœ€é©åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Azure Firewall SKU æ¯”è¼ƒ (æœˆé¡æ¦‚ç®—)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ Basic Tier (é¸æŠ)        â† æœ€ã‚‚å®‰ä¾¡                     â”‚
â”‚ â”œâ”€ å›ºå®šæ–™é‡‘: ç´„ $3.50/æ—¥ ($105/æœˆ)                     â”‚
â”‚ â”œâ”€ ãƒ‡ãƒ¼ã‚¿å‡¦ç†: ç´„ $0.0045/GB                           â”‚
â”‚ â””â”€ æ©Ÿèƒ½:                                               â”‚
â”‚    - FQDN ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (ã‚¯ãƒ©ã‚¦ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œ)     â”‚
â”‚    - NATãƒ«ãƒ¼ãƒ«, ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«                     â”‚
â”‚    - Application Insights ãƒ­ã‚°                        â”‚
â”‚                                                          â”‚
â”‚ Standard Tier                                           â”‚
â”‚ â”œâ”€ å›ºå®šæ–™é‡‘: ç´„ $4.20/æ—¥                               â”‚
â”‚ â”œâ”€ ãƒ‡ãƒ¼ã‚¿å‡¦ç†: ç´„ $0.0045/GB                           â”‚
â”‚ â””â”€ è¿½åŠ æ©Ÿèƒ½: TLS æ¤œæŸ», Threat Intelligence ãªã©        â”‚
â”‚                                                          â”‚
â”‚ Premium Tier                                            â”‚
â”‚ â”œâ”€ å›ºå®šæ–™é‡‘: ç´„ $5.00/æ—¥                               â”‚
â”‚ â””â”€ è¿½åŠ æ©Ÿèƒ½: IDS/IPS, URL ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã©           â”‚
â”‚                                                          â”‚
â”‚ ğŸ’¡ ã“ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ Basic ã§ååˆ†                       â”‚
â”‚    (é–‹ç™º/ãƒ†ã‚¹ãƒˆç”¨é€”)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼

```
VM â†’ Firewall ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ (Local Network)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VM Private IP: 172.30.20.x              â”‚
â”‚ â†’ Firewall Private IP: 172.30.1.4       â”‚
â”‚ - ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ã™ã¹ã¦ (TCP, UDP, ICMP)  â”‚
â”‚ - ãƒãƒ¼ãƒˆ: ã™ã¹ã¦ (AllowAll ãƒ«ãƒ¼ãƒ«)     â”‚
â”‚ - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: ä½ã„ (åŒä¸€ VNet)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
Firewall â†’ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source: Firewall Public IP              â”‚
â”‚         (fw-pip-japaneast)              â”‚
â”‚ Destination: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒ›ã‚¹ãƒˆ       â”‚
â”‚ - NAT: VM Private IP â†’ Firewall Pub IP â”‚
â”‚ - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«è©•ä¾¡               â”‚
â”‚ - Threat Intelligence æ¤œæŸ»             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ â†’ Firewall ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ (å¤–éƒ¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒ›ã‚¹ãƒˆ            â”‚
â”‚ Destination: Firewall Public IP         â”‚
â”‚ - Stateful ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«å‡¦ç†        â”‚
â”‚ - å¿œç­”ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿è¨±å¯             â”‚
â”‚ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ Deny (ãƒ«ãƒ¼ãƒ«ä¸€è‡´å¿…é ˆ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒˆãƒãƒ­ã‚¸ãƒ¼æ¦‚è¦è¡¨

| ãƒªã‚½ãƒ¼ã‚¹ | å€¤ | èª¬æ˜ |
|---------|-----|------|
| **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (Firewall)** | Japan East (japaneast) | Azure Firewall ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä½ç½® |
| **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (VM)** | Southeast Asia (southeastasia) | ãƒ†ã‚¹ãƒˆ VM ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä½ç½® |
| **VNet (æ±æ—¥æœ¬)** | je-vnet, 172.30.0.0/23 | Firewall æ ¼ç´ VNet |
| **VNet (æ±å—äºœ)** | sea-vnet, 172.30.20.0/24 | ãƒ†ã‚¹ãƒˆ VM æ ¼ç´ VNet |
| **Firewall Subnet** | AzureFirewallSubnet, 172.30.1.0/24 | Firewall å°‚ç”¨ã‚µãƒ–ãƒãƒƒãƒˆ |
| **VM Subnet** | test-sea, 172.30.20.0/25 | ãƒ†ã‚¹ãƒˆ VM æ ¼ç´ã‚µãƒ–ãƒãƒƒãƒˆ |
| **Firewall SKU** | AZFW_VNet / Basic | æœ€å°ã‚³ã‚¹ãƒˆæ§‹æˆ |
| **Firewall Priv IP** | 172.30.1.4 (å‹•çš„) | UDR Next Hop IP |
| **Firewall Pub IP** | fw-pip-japaneast (Static) | å¤–éƒ¨é€šä¿¡ç”¨ IP |
| **Route Table** | udr-sea-to-firewall | UDR ãƒ†ãƒ¼ãƒ–ãƒ«å |
| **Route Rule** | 0.0.0.0/0 â†’ 172.30.1.4 | ã™ã¹ã¦ã®å¤–éƒ¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯â†’Firewall |
| **VNet Peering** | je-vnet â†” sea-vnet | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“é€šä¿¡æœ‰åŠ¹ |
| **VM Size** | Standard_B4ms | ãƒ†ã‚¹ãƒˆ VM ã‚µã‚¤ã‚º |
| **VM OS** | Windows Server 2022 Datacenter | ãƒ†ã‚¹ãƒˆ VM ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  |

## ä»Šå¾Œã®æ”¹å–„

```
æœ¬ç•ªç’°å¢ƒã¸ã®ç§»è¡Œæ™‚ã®æ¤œè¨é …ç›®:

1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«è¨­å®šã®å³å¯†åŒ–
   - ç¾åœ¨: AllowAll (é–‹ç™ºç”¨)
   - æœ¬ç•ª: å¿…è¦ãªé€šä¿¡ã®ã¿ã‚’è¨±å¯

2. Firewall ãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ« (FQDN ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
   - NAT ãƒ«ãƒ¼ãƒ« (ãƒãƒ¼ãƒˆå¤‰æ›)
   - ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ã‚«ãƒ†ã‚´ãƒª

3. ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
   - Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ¥ç¶š
   - Azure Monitor ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
   - Firewall ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–

4. é«˜å¯ç”¨æ€§æ§‹æˆ
   - è¤‡æ•° Availability Zone ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤
   - Firewall ã®å†—é•·æ€§è¨­å®š

5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã®å‘ä¸Š
   - Standard ã¾ãŸã¯ Premium SKU ã¸ã®æ®µéšçš„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
   - Threat Intelligence ã®è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š
   - DDoS Protection Standard ã®æœ‰åŠ¹åŒ–

6. ã‚³ã‚¹ãƒˆç®¡ç†
   - Azure Cost Management ã§ã®ç›£è¦–
   - ãƒªã‚¶ãƒ¼ãƒ–ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ¤œè¨
   - ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚³ã‚¹ãƒˆã®æœ€é©åŒ–
```
